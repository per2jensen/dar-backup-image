# .github/workflows/ci.yml
name: CI — build, test, scan
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

  workflow_dispatch: {}

permissions:
  contents: write
  packages: write         # for GHCR push/pull
  security-events: write  # for SARIF upload

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: dar-backup
  CI_TAG: ci-${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-24.04
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - uses: actions/checkout@v4
      - name: Read DAR_BACKUP_VERSION
        id: ver
        run: echo "v=$(cat DAR_BACKUP_VERSION)" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set meta
        id: meta
        run: echo "image_ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CI_TAG }}" >> $GITHUB_OUTPUT

      - name: Build with Makefile and tag locally
        run: |
          make FINAL_VERSION=dev DAR_BACKUP_VERSION=${{ steps.ver.outputs.v }} dev
          docker tag dar-backup:dev "${{ steps.meta.outputs.image_ref }}"

      - name: Push to GHCR (temp CI tag)
        run: docker push "${{ steps.meta.outputs.image_ref }}"

  test:
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Prepare summary directory
        run: mkdir -p "ci-summary"

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install required system packages
        run: |
          sudo apt update
          sudo apt install -y python3

      - name: Create and prepare Python virtual environment
        run: |
          cd $GITHUB_WORKSPACE
          if [[ -d venv* ]]; then
            rm -rf venv*
          fi
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install pytest pytest-json-report

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull CI image
        run: docker pull "${{ needs.build.outputs.image_ref }}"

      - name: Ensure image exists
        run: docker image inspect "${{ needs.build.outputs.image_ref }}" > /dev/null

      - name: Show image digest
        run: docker image inspect "${{ needs.build.outputs.image_ref }}" --format '{{.RepoTags}} {{.Id}} {{.Size}}'
      - name: Run FULL, DIFF & INCR tests
        run: |
          . venv/bin/activate
          make IMAGE="${{ needs.build.outputs.image_ref }}" test-nobuild

      - name: Summarize unit test results
        if: always()
        run: |
          if [ -f pytest-report.json ]; then
            total=$(jq '.summary.total' pytest-report.json)
            passed=$(jq '.summary.passed' pytest-report.json)
            failed=$(jq '.summary.failed' pytest-report.json)
            skipped=$(jq '.summary.skipped' pytest-report.json)
            rate=$(jq -n "100 * $passed / $total" | xargs printf "%.1f")

            jq -n --argjson total "$total" \
                  --argjson passed "$passed" \
                  --argjson failed "$failed" \
                  --argjson skipped "$skipped" \
                  --arg rate "$rate" \
                  '{
                    test: {
                      total: $total,
                      passed: $passed,
                      failed: $failed,
                      skipped: $skipped,
                      pass_rate: $rate
                    }
                  }' > ci-summary/test.json
          fi
      - name: Upload ci-summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary-${{ github.job }}
          path: ci-summary




  # Run end-to-end backup/restore/compare tests in a container
  # Run FULL, DIFF, INCR cycle
  # Create/modify/delete files between runs
  # Verify that restore matches original data after each restore
  # using a temporary dataset created in the workflow
  # This is a more realistic test of the actual backup/restore process
  # than the unit tests in `test` job. 
  backup-restore-compare:
    needs: build
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Prepare summary directory
        run: mkdir -p ci-summary

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull CI image
        run: docker pull "${{ needs.build.outputs.image_ref }}"

      - name: Ensure image exists
        run: docker image inspect "${{ needs.build.outputs.image_ref }}" > /dev/null

      - name: Read DAR_BACKUP_VERSION
        id: ver
        run: echo "v=$(cat DAR_BACKUP_VERSION)" >> $GITHUB_OUTPUT

      - name: Compute artifact naming components
        id: naming
        run: |
          DATE=$(date +%Y%m%d)
          SHA=$(sha256sum grype-report.txt | cut -c1-12)
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Run E2E backup/restore/compare
        run: |
          set -euo pipefail
          # Use the shared script to keep CI in sync with local e2e behavior (PITR restore + report).
          IMAGE="${{ needs.build.outputs.image_ref }}" LIST_CONTENTS=1 ./scripts/backup-restore-compare.sh

      - name: Summarize E2E backup/restore results
        if: always()
        run: |
          summary='{}'
          DATE="$(date +%Y-%m-%d)"
          WORKDIR="$(pwd)/.e2e"
          overall_status="success"

          for phase in FULL DIFF INCR; do
            archive="default_${phase}_${DATE}"
            diff_file="$WORKDIR/diff-${archive}.txt"

            if [[ -s "$diff_file" ]]; then
              status="mismatch"
              notes="Differences found in ${phase} restore"
              diff_lines=$(wc -l < "$diff_file")
              overall_status="failure"
            else
              status="ok"
              notes="Restore matches source"
              diff_lines=0
            fi

            summary=$(echo "$summary" | jq --arg phase "$phase" \
                                          --arg status "$status" \
                                          --argjson diff "$diff_lines" \
                                          --arg notes "$notes" \
              '. + {($phase): {status: $status, diff_lines: $diff, notes: $notes}}')
          done

          jq -n --argjson phases "$summary" \
                --arg status "$overall_status" \
                '{
                  backup_restore_compare: {
                    phases: $phases,
                    overall_status: $status
                  }
                }' > ci-summary/e2e.json

      - name: Upload ci-summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary-${{ github.job }}
          path: ci-summary


  sbom_vuln_scan:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      GRYPE_DB_AUTO_UPDATE: "true"
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - uses: actions/checkout@v4

      - name: Prepare summary directory
        run: mkdir -p ci-summary

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull CI image
        run: docker pull "${{ needs.build.outputs.image_ref }}"

      - name: Compute Grype cache key
        id: cache-key
        run: |
          VER=$(curl -sL https://raw.githubusercontent.com/anchore/grype/main/VERSION)
          echo "ver=$VER" >> $GITHUB_OUTPUT
          echo "week=$(date +%G-%V)" >> $GITHUB_OUTPUT

      - name: Cache Grype DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/grype
          key: grype-db-${{ runner.os }}-${{ runner.arch }}-${{ steps.cache-key.outputs.ver }}-${{ steps.cache-key.outputs.week }}
          restore-keys: |
            grype-db-${{ runner.os }}-${{ runner.arch }}-${{ steps.cache-key.outputs.ver }}-
            grype-db-${{ runner.os }}-${{ runner.arch }}-

      - name: Install Syft
        run: curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      - name: Install Grype
        run: curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Update Grype DB (optional)
        if: env.GRYPE_DB_AUTO_UPDATE == 'true'
        run: grype db update

      - name: Show Grype DB status
        run: grype db status

      - name: Generate SBOM
        run: |
          set -euo pipefail
          if ! syft "docker:${{ needs.build.outputs.image_ref }}" -o cyclonedx-json > sbom-cyclonedx.json; then
            echo "⚠️  syft docker source failed, retrying via registry"
            rm -f sbom-cyclonedx.json
            syft "registry:${{ needs.build.outputs.image_ref }}" -o cyclonedx-json > sbom-cyclonedx.json
          fi

      - name: SBOM sanity check
        run: |
          test -s sbom-cyclonedx.json
          wc -c sbom-cyclonedx.json
          grep -q '"components"' sbom-cyclonedx.json || { echo 'SBOM missing components key'; exit 1; }

      - name: Scan with Grype (fail on high/critical)
        run: |
          set -e
          grype "sbom:sbom-cyclonedx.json" -o table --fail-on High | tee grype-report.txt
          grype "sbom:sbom-cyclonedx.json" -o sarif > grype.sarif

      - name: Upload SBOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom-cyclonedx.json

      - name: Upload Grype report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-report
          path: grype-report.txt

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype.sarif

      - name: Job summary
        if: always()
        run: |
          comps=$(jq '.components|length' sbom-cyclonedx.json || echo 0)
          vulns=$(grype "sbom:sbom-cyclonedx.json" -o json | jq '.matches|length' || echo 0)
          {
            echo "### SBOM / Vulnerabilities"
            echo "- Image: ${{ needs.build.outputs.image_ref }}"
            echo "- Components: $comps"
            echo "- Vulnerabilities (all severities): $vulns"
          } >> "$GITHUB_STEP_SUMMARY"


      - name: Summarize SBOM and vulnerabilities by severity
        if: always()
        run: |
          comps=$(jq '.components|length' sbom-cyclonedx.json || echo 0)

          grype "sbom:sbom-cyclonedx.json" -o json > grype-results.json

          total=$(jq '.matches | length' grype-results.json)
          critical=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-results.json)
          high=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' grype-results.json)
          medium=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' grype-results.json)
          low=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' grype-results.json)
          negligible=$(jq '[.matches[] | select(.vulnerability.severity == "Negligible")] | length' grype-results.json)
          unknown=$(jq '[.matches[] | select(.vulnerability.severity == "Unknown")] | length' grype-results.json)

          jq -n --arg image "${{ needs.build.outputs.image_ref }}" \
                --argjson comps "$comps" \
                --argjson total "$total" \
                --argjson critical "$critical" \
                --argjson high "$high" \
                --argjson medium "$medium" \
                --argjson low "$low" \
                --argjson negligible "$negligible" \
                --argjson unknown "$unknown" \
                '{
                  sbom_vuln_scan: {
                    image: $image,
                    components: $comps,
                    vulnerabilities: {
                      total: $total,
                      by_severity: {
                        critical: $critical,
                        high: $high,
                        medium: $medium,
                        low: $low,
                        negligible: $negligible,
                        unknown: $unknown
                      }
                    }
                  }
                }' > ci-summary/sbom.json


      - name: Upload ci-summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary-${{ github.job }}
          path: ci-summary

  summarize:
    runs-on: ubuntu-24.04
    needs: [test, backup-restore-compare, sbom_vuln_scan]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq


      - name: Sync main
        shell: bash
        run: |
          set -euo pipefail
          git pull --rebase origin main

      - name: Download all summaries
        uses: actions/download-artifact@v4
        with:
          pattern: ci-summary-*
          merge-multiple: true
          path: ci-summary

      - name: Merge and wrap (tmp only)
        shell: bash
        run: |
          set -euo pipefail
          T="$(mktemp -d)"
          shopt -s nullglob
          files=(ci-summary/*.json)
          if (( ${#files[@]} == 0 )); then
            echo '{}' > "$T/ci-summary.json"
          else
            jq -s 'reduce .[] as $i ({}; . * $i)' "${files[@]}" > "$T/ci-summary.json"
          fi

          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          jq -n --arg ts "$ts" \
                --arg workflow "${{ github.workflow }}" \
                --arg commit   "${{ github.sha }}" \
                --arg branch   "${{ github.ref }}" \
                --arg actor    "${{ github.actor }}" \
                --arg run_id   "${{ github.run_id }}" \
                --arg run_url  "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
                --slurpfile s "$T/ci-summary.json" \
                '{timestamp:$ts,workflow_name:$workflow,git_commit:$commit,branch:$branch,actor:$actor,run_id:$run_id,run_url:$run_url,summary:$s[0]}' \
                > "$T/new-entry.json"

          mkdir -p doc
          [[ -f doc/build-test-scan-report.json ]] || echo "[]" > doc/build-test-scan-report.json

          RETAIN="${RETAIN:-500}"

          jq -S --argjson r "$RETAIN" --slurpfile entry "$T/new-entry.json" '
            (. + $entry) as $a
            | if ($a|length) > $r
              then $a[(($a|length)-$r):]
              else $a
              end
          ' doc/build-test-scan-report.json > "$T/report.json"

          if cmp -s "$T/report.json" doc/build-test-scan-report.json; then
            echo "UNCHANGED=1" >> $GITHUB_ENV
          else
            mv "$T/report.json" doc/build-test-scan-report.json
            echo "UNCHANGED=0" >> $GITHUB_ENV
          fi

      - name: Gate on results (optional but recommended)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          overall=$(jq -r '.[-1].summary.backup_restore_compare.overall_status' doc/build-test-scan-report.json)
          highs=$(jq '.[-1].summary.sbom_vuln_scan.vulnerabilities.by_severity.high // 0' doc/build-test-scan-report.json)
          crits=$(jq '.[-1].summary.sbom_vuln_scan.vulnerabilities.by_severity.critical // 0' doc/build-test-scan-report.json)
          rate=$(jq -r '.[-1].summary.test.pass_rate // "0"' doc/build-test-scan-report.json)
          echo "overall=$overall high=$highs critical=$crits pass_rate=$rate"
          [[ "$overall" == "success" ]] || { echo "E2E failed"; exit 1; }
          [[ "$highs" -eq 0 && "$crits" -eq 0 ]] || { echo "High/Critical vulns present"; exit 1; }

      - name: Write job summary
        shell: bash
        run: |
          set -euo pipefail
          last='.[-1]'
          {
            echo "### CI Summary"
            echo "- Commit: \`$(jq -r "$last.git_commit" doc/build-test-scan-report.json)\`"
            echo "- Run: $(jq -r "$last.run_url" doc/build-test-scan-report.json)"
            echo ""
            echo "**E2E:** $(jq -r "$last.summary.backup_restore_compare.overall_status" doc/build-test-scan-report.json)"
            echo ""
            echo "**Tests:** $(jq -r "$last.summary.test.passed" doc/build-test-scan-report.json)/$(jq -r "$last.summary.test.total" doc/build-test-scan-report.json) passed"
            echo ""
            echo "**Vulns:** total $(jq -r "$last.summary.sbom_vuln_scan.vulnerabilities.total" doc/build-test-scan-report.json)  " \
                "H:$(jq -r "$last.summary.sbom_vuln_scan.vulnerabilities.by_severity.high" doc/build-test-scan-report.json) " \
                "C:$(jq -r "$last.summary.sbom_vuln_scan.vulnerabilities.by_severity.critical" doc/build-test-scan-report.json)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Commit and push updated report
        if: github.ref == 'refs/heads/main' && env.UNCHANGED != '1'
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name  "github-actions"
          git config --global user.email "github-actions@github.com"
          git add -f doc/build-test-scan-report.json
          git commit -m "CI summary: run ${{ github.run_id }}" || exit 0
          git push origin HEAD:main
