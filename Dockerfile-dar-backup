# dar-backup
#
# Build with:
#   sudo docker build -f Dockerfile-dar-backup -t dar-backup:0.5.0- .
#

FROM dar-backup-base:24.04

ARG VERSION=0.0.0
ARG DAR_BACKUP_VERSION

LABEL org.opencontainers.image.source="https://github.com/per2jensen/dar-backup-image" \
      org.opencontainers.image.description="Container for DAR-based backups using `dar-backup`" \
      org.opencontainers.image.version="${VERSION}"

ENV DEBIAN_FRONTEND=noninteractive

# Install the dar-backup PyPI package
RUN echo "🛠️ Installing dar-backup..." && \
    if [ -n "$DAR_BACKUP_VERSION" ]; then \
      pip3 install "dar-backup==$DAR_BACKUP_VERSION" --break-system-packages; \
    else \
      pip3 install dar-backup --break-system-packages; \
    fi && \
    pip3 show dar-backup || (echo "❌ dar-backup not installed" && exit 1)


# PATH
RUN echo "PATH=$PATH"

# Fail early if it's not on PATH
RUN echo "look for dar-backup in PATH: $PATH"
RUN [ -x "$(command -v dar-backup)" ] || (echo "❌ dar-backup not executalbe" && exit 1)

# Final validation
RUN echo "🔍 Checking dar-backup..." 
RUN if ! command -v dar-backup >/dev/null; then \
      echo "❌ dar-backup not found in PATH" && exit 1; \
    fi && \
    version="$(dar-backup --version 2>/dev/null)" && \
    echo "✅ Installed dar-backup version: $version"


# Copy the default configuration
COPY dar-backup.conf /etc/dar-backup/dar-backup.conf

# Default environment variables (can be overridden at runtime)
ENV DAR_BACKUP_CONFIG=/etc/dar-backup/dar-backup.conf \
    DAR_BACKUP_DIR=/backups \
    DAR_BACKUP_D_DIR=/backup.d \
    DAR_BACKUP_RESTORE_DIR=/restore \
    DAR_BACKUP_DATA_DIR=/data

# Copy the entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Entrypoint and default arguments
ENTRYPOINT ["/entrypoint.sh"]
CMD ["--verbose", "--log-stdout"]


RUN echo "✅ dar-backup image built successfully with version ${VERSION} and DAR_BACKUP_VERSION ${DAR_BACKUP_VERSION}"