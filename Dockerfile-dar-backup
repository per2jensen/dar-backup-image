FROM dar-backup-base:24.04

ARG VERSION=0.0.0
ARG DAR_BACKUP_VERSION

LABEL org.opencontainers.image.source="https://github.com/per2jensen/dar-backup-image" \
      org.opencontainers.image.description="Container for DAR-based backups using `dar-backup`" \
      org.opencontainers.image.version="${VERSION}"

ENV DEBIAN_FRONTEND=noninteractive

# Install the dar-backup PyPI package and validate installation
RUN echo "ðŸ› ï¸ Installing dar-backup..." && \
    if [ -n "$DAR_BACKUP_VERSION" ]; then \
      pip3 install "dar-backup==$DAR_BACKUP_VERSION" --no-compile  --no-cache-dir --break-system-packages; \
    else \
      pip3 install dar-backup --no-compile  --no-cache-dir  --break-system-packages; \
    fi && \
    pip3 show dar-backup || (echo "âŒ dar-backup not installed" && exit 1) && \
    echo "ðŸ” Checking dar-backup..." && \
    if ! command -v dar-backup >/dev/null; then \
      echo "âŒ dar-backup not found in PATH" && exit 1; \
    fi && \
    version="$(dar-backup --version 2>/dev/null)" && \
    echo "âœ… Installed dar-backup version: $version" && \
    echo "âœ… dar-backup image built successfully with version ${VERSION} and DAR_BACKUP_VERSION ${DAR_BACKUP_VERSION}"  && \
    find /usr -type d -name '__pycache__' -exec rm -rf {} + && \
    find /usr -type f -name '*.pyc' -delete  && \
    rm -rf /root/.cache/pip  && \
    apt-get autoremove -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*



# Copy configuration and entrypoint
COPY dar-backup.conf /etc/dar-backup/dar-backup.conf
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment configuration
ENV DAR_BACKUP_CONFIG=/etc/dar-backup/dar-backup.conf \
    DAR_BACKUP_DIR=/backups \
    DAR_BACKUP_D_DIR=/backup.d \
    DAR_BACKUP_RESTORE_DIR=/restore \
    DAR_BACKUP_DATA_DIR=/data

# Entrypoint and default args
ENTRYPOINT ["/entrypoint.sh"]

